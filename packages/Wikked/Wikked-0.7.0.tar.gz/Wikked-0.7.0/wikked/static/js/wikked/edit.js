define(["jquery","jquery_validate","underscore"],function(e,t,n){var r={},i=r.run=function(){var e=new s;window.wikkedEditView=e};e.validator.setDefaults({highlight:function(t){e(t).closest(".form-group").addClass("has-error").removeClass("has-success")},unhighlight:function(t){e(t).closest(".form-group").removeClass("has-error").addClass("has-success")},errorElement:"span",errorClass:"help-block",errorPlacement:function(e,t){t.parent(".input-group").length?e.insertAfter(t.parent()):e.insertAfter(t)}});var s=r.EditPageView=function(){this.initialize.apply(this,arguments)};return n.extend(s.prototype,{initialize:function(){this.inputSection=e(".editing-input"),this.inputCtrl=e("#editing-input-area"),this.previewSection=e(".editing-preview"),this.previewButtonLabel=e(".editing-preview-button-label"),this.previewSection.hide(),this.errorSection=e(".editing-error"),this.errorSection.hide(),e("#page-edit").validate({rules:{title:{required:!0,remote:{url:"/api/validate/newpage",type:"post"}}}}),this.listen("#editing-input-grip","mousedown","_inputGripMouseDown"),this.listen("#editing-preview-button","click","_togglePreview")},listen:function(t,n,r){var i=this;e(t).on(n,function(e){i[r](e)})},_inputGripMouseDown:function(t){var n=this,r=t.pageY;e("body").on("mousemove.wikked.editor_resize",function(e){var t=n.inputCtrl;t.height(t.height()+e.pageY-r),r=e.pageY}).on("mouseup.wikked.editor_resize mouseleave.wikked.editor_resize",function(t){e("body").off(".wikked.editor_resize")})},_togglePreview:function(t){t.preventDefault();if(this.previewSection.is(":visible"))return this.inputCtrl.height(Math.max(this.inputCtrl.height(),this.previewSection.height()-12)),this.inputSection.show(),this.previewSection.hide(),this.previewButtonLabel.html("Preview"),!1;var n=this,r=e("#editing-preview-button"),i={url:r.attr("data-wiki-url"),text:this.inputCtrl.val()};return this.previewSection.html("<p>Loading...</p>"),this.previewSection.height(this.inputSection.height()),this.previewSection.show(),this.inputSection.hide(),e.post("/api/preview",i).success(function(e){var t=n.previewSection;t.height("auto"),t.html(e.text),t.height(Math.max(t.height(),n.inputSection.height())),t.show(),n.inputSection.hide(),n.previewButtonLabel.html("Edit"),n.errorSection.hide()}).error(function(){e(".editing-error-message").html("Error running preview."),n.errorSection.show()}),!1}}),r});