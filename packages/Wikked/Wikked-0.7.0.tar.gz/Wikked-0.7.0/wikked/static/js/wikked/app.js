define(["jquery","underscore"],function(e,t){var n={},r=n.run=function(){var e=new i;window.wikkedNav=e},i=n.NavigationView=function(){this.initialize.apply(this,arguments)};return t.extend(i.prototype,{initialize:function(){this.searchPreviewList=e("#search-preview"),this.searchPreviewList.hide(),this.activeResultIndex=-1,this.wikiMenu=e("#wiki-menu"),this.wikiMenuAndWrapper=e.merge(this.wikiMenu,e("#app .wrapper")),this.isMenuActive=this.wikiMenu.css("left")=="0px",this.isMenuActiveLocked=!1,this.listen("#wiki-menu-shortcut","click","_onMenuShortcutClick"),this.listen("#wiki-menu-pin","click","_onMenuShortcutClick"),this.listen("#wiki-menu-shortcut","mouseenter","_onMenuShortcutHover"),this.listen("#wiki-menu-shortcut","mouseleave","_onMenuShortcutLeave"),this.listen("#wiki-menu","mouseenter","_onMenuHover"),this.listen("#wiki-menu","mouseleave","_onMenuLeave"),this.listen("#search-query","focus","_searchQueryFocused"),this.listen("#search-query","input","_previewSearch"),this.listen("#search-query","keyup","_searchQueryChanged"),this.listen("#search-query","blur","_searchQueryBlurred"),this.listen("#search","submit","_submitSearch")},listen:function(t,n,r){var i=this;e(t).on(n,function(e){i[r](e)})},_setNavHiddenCookie:function(e){document.cookie="wiki-hide-nav="+e+"; "+"path=/; expires=31 Dec 2100 UTC"},_onMenuShortcutClick:function(e){this.isMenuActive=!this.isMenuActive;var t=this.isMenuActive?"0":"1";this._setNavHiddenCookie(t),this._toggleWikiMenuPin(this.isMenuActive)},_onMenuShortcutHover:function(e){!this.isMenuActive&&!this.isMenuActiveLocked&&this._toggleWikiMenu(!0)},_onMenuShortcutLeave:function(e){!this.isMenuActive&&!this.isMenuActiveLocked&&this._toggleWikiMenu(!1)},_onMenuHover:function(e){!this.isMenuActive&&!this.isMenuActiveLocked&&this._toggleWikiMenu(!0)},_onMenuLeave:function(e){!this.isMenuActive&&!this.isMenuActiveLocked&&this._toggleWikiMenu(!1)},_toggleWikiMenu:function(e){e?(this.wikiMenuAndWrapper.toggleClass("wiki-menu-inactive",!1),this.wikiMenuAndWrapper.toggleClass("wiki-menu-active",!0)):(this.wikiMenuAndWrapper.toggleClass("wiki-menu-active",!1),this.wikiMenuAndWrapper.toggleClass("wiki-menu-inactive",!0))},_toggleWikiMenuPin:function(t){e("#wiki-menu-pin").toggleClass("wiki-menu-pin-active",t)},_searchQueryFocused:function(e){this.isMenuActiveLocked=!0,this.wikiMenu.toggleClass("wiki-menu-ext",!0)},_searchQueryBlurred:function(t){this.wikiMenu.toggleClass("wiki-menu-ext",!1),this.isMenuActiveLocked=!1,this.searchPreviewList.is(":visible")&&this.searchPreviewList.slideUp(200),e(document.activeElement).parents("#wiki-menu").length===0&&this._onMenuLeave(t)},_submitSearch:function(t){if(this.activeResultIndex>=0){var n=this.searchPreviewList.children(),r=e("a",n[this.activeResultIndex]),i=r.attr("href")+"?no_redirect";return window.location.href=i,t.preventDefault(),!1}return!0},_previewSearch:function(t){var n=e(t.currentTarget).val();if(n&&n.length>=1){var r=this;this._doPreviewSearch(n,function(e){var t="";for(var n=0;n<e.hits.length;++n){var i=e.hits[n].url.replace(/^\//,"");t+='<li><a href="/read/'+i+'">'+e.hits[n].title+"</a>"+"</li>"}r.searchPreviewList.html(t),r.searchPreviewList.is(":visible")||r.searchPreviewList.slideDown(200)})}else(!n||n.length===0)&&this.searchPreviewList.slideUp(200)},_isSearching:!1,_pendingQuery:null,_pendingCallback:null,_doPreviewSearch:function(t,n){if(this._isSearching){this._pendingQuery=t,this._pendingCallback=n;return}this._isSearching=!0;var r=this;e.getJSON("/api/searchpreview",{q:t}).done(function(e){r._isSearching=!1,n(e),r._flushPendingQuery()}).fail(function(){r._isSearching=!1,r._flushPendingQuery()})},_flushPendingQuery:function(){if(this._pendingQuery&&this._pendingCallback){var e=this._pendingQuery,t=this._pendingCallback;this._pendingQuery=null,this._pendingCallback=null,this._doPreviewSearch(e,t)}},_searchQueryChanged:function(t){t.keyCode==27?e(t.currentTarget).val("").trigger("input"):t.keyCode==38?(t.preventDefault(),this.activeResultIndex>=0&&(this.activeResultIndex--,this._updateActiveResult())):t.keyCode==40&&(t.preventDefault(),this.activeResultIndex<this.searchPreviewList.children().length-1&&(this.activeResultIndex++,this._updateActiveResult()))},_updateActiveResult:function(){var t=this.searchPreviewList.children();t.toggleClass("search-result-hover",!1),this.activeResultIndex>=0&&e(t[this.activeResultIndex]).toggleClass("search-result-hover",!0)}}),n});