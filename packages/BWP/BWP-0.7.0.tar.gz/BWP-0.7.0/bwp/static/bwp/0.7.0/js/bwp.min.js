var NEWOBJECTKEY="newObject",FIELD=null,delay=null,ACTION_WAIT=null,FILTER_TYPES=[["exact","Равно",1],["gt","Больше",1],["gte","Больше или равно",1],["lt","Меньше",1],["lte","Меньше или равно",1],["range","Диапазон",2],["in","Список",99],["icontains","Содержит",1],["istartswith","Начинается",1],["iendswith","Заканчивается",1],["isnull","Пусто",0],["blank","Пустая строка",0],];window.TEMPLATES={};window.REGISTER={};_.mixin(_.str.exports());function isEmpty(b){for(var a in b){return false}return true}delay=(function(){var a=0;return function(c,b){clearTimeout(a);a=setTimeout(c,b)}})();function generatorID(d,h){var b=[],f="i",a=1000,g=9999,c=Math.floor(Math.random()*(g-a+1))+a;f+=$.now()+String(c);if(d){b.push(d)}b.push(f);if(h){b.push(h)}return validatorID(b)}function validatorID(a){if($.type(a)==="array"){a=a.join("_")}return a.replace(/[\.,\:,\/, ,\(,\),=,?]/g,"-")}function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(d,g,b,a){if(DEBUG){console.log("function:handlerShowAlert")}if(!b){b="alert-error"}var c,f=60000;if($.type(g)=="object"){g=$.toJSON(g).replace(/\,\"/g,', "').replace(/\"\:/g,'": ')}else{if(g.match(/<\!DOCTYPE/)){c=g.match(/<[title,TITLE]+>(.*)<\/[title,TITLE]+>/);if(c){d=c[1]}c=g.match(/<[body,BODY]+>([^+]*)<\/[body,BODY]+>/);if(c){g=c[1].replace(/<\/?[^>]+>/g,"").replace(/ [ ]+/g," ").replace(/\n[\n]+/g,"\n")}}}if(g.length>1024){g=g.substring(0,1024)+" ..."}html=TEMPLATES.alert({head:d,msg:g,cls:b});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert().on("closed.bs.alert",handlerHideAlert);if(a){delay(a,f)}else{delay(handlerHideAlert,f)}return false}function jsonAPI(a,g,d,b,c){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"get_settings"}}if(b){console.log("SYNCRONOUS REQUEST!!!",a,d)}var f=$.quickAPI({url:BWP_API_URL,data:a,async:!b,timeout:c||AJAX_TIMEOUT,callback:g,log:undefined,});return f}function classSettings(a){this.meta={};self=this;if((typeof localStorage=="undefined")||(typeof $.evalJSON=="undefined")){return{}}_unique_key=SETTINGS_UNIQUE_KEY;_server={};_local={tabs:[],filters:{},};_values={server:_server,local:_local};_values_is_set=false;_responseServer=null;this.__defineGetter__("ready",function(){return _values_is_set});_callback=a;_run_callback=function(){if(_callback instanceof Function){_callback();if(!_callback.__not_reset_after__){_callback=a}}};this.callback=_callback;_last_set_server=null;this.last_set=_last_set_server;_last_get_server=null;this.last_get=_last_get_server;_init=function(b){if(b){_callback=b}_values_is_set=false;_local=$.evalJSON(localStorage.getItem(_unique_key))||_local;_get_server();return self};this.init=_init;this.reload=_init;_check_init=function(){if(!_values_is_set){_init()}return self};this.__defineGetter__("all",function(){_check_init();return _values});this.__defineGetter__("server",function(){_check_init();return _server});this.__defineGetter__("local",function(){_check_init();return _local});this.save=function(c,b){if(c){_callback=c}if(b!="local"){_set_server()}if(b!="server"){localStorage.setItem(_unique_key,$.toJSON(self.local))}_run_callback();return self};this.save_server=function(b){return self.save(b,"server")};this.save_local=function(b){return self.save(b,"local")};_set_server=function(){_responseServer=null;args={method:"set_settings",settings:self.server};cb=function(c,b,d){if(!c.data){handlerShowAlert("Ошибка",c.message)}else{_last_set_server=new Date();_responseServer=c}};jqxhr=new jsonAPI(args,cb,"SETTINGS.set_server() call jsonAPI()");return[_last_set_server,_responseServer,jqxhr]};_get_server=function(){_responseServer=null;args={method:"get_settings"};cb=function(c,b,d){_server=c.data;_last_get_server=new Date();_responseServer=c;_values_is_set=true;_run_callback()};jqxhr=new jsonAPI(args,cb,"SETTINGS.get_server() call jsonAPI()");return[_last_get_server,_responseServer,jqxhr]};this.cleanTabs=function(){_tabs=[];$.each(_local.tabs,function(b,c){if(c){_tabs.push(c)}});_local.tabs=_tabs;return self}}function classApp(b){this.has_module_perms=b.has_module_perms;this.name=b.name;this.id=validatorID(this.name);this.label=b.label;this.title="Приложение:"+this.label;var a=[];this.models=a;var c=this;$.each(b.models,function(d,f){a.push(new classModel(c,f))});REGISTER[this.id]=this}function classModel(g,f){this.template=TEMPLATES.layoutModel;this.app=g;this.perms=f.perms;this.meta=f.meta;this.name=f.name;this.model=this.name;this.id=validatorID(this.model);this.label=f.label;this.title=this.app.label+": "+this.label;this.query=null;this.fix={};this.paginator=null;var h=[];this.collection_reports=h;var c=[];this.object_reports=c;var b={};this.composes=b;var d={};this.actions=d;var a=this;if(f.meta.compositions){$.each(f.meta.compositions,function(i,j){b[j.meta.related_name]=j})}if(f.meta.reports){$.each(f.meta.reports,function(i,j){if(j.for_object){c.push(j)}else{h.push(j)}});if(this.collection_reports.length<1){this.collection_reports=null}if(this.object_reports.length<1){this.object_reports=null}}if((!this.meta)||(!this.meta.list_display)){console.log("Модель не может быть зарегистрирована.")}else{REGISTER[this.id]=this}}function classSelector(c,b){$.extend(true,this,c);this.id=validatorID([this.id,"selector"]);this.template=TEMPLATES.layoutSelector;this.perms={"delete":false,add:false,change:false};this.actions=null;this.meta.list_display=this.meta.list_display;this.meta.list_per_page=5;this.multiple=b?true:false;var a=this;REGISTER[this.id]=this;this.get_checked_items=function(){_checkboxes=$("#collection_"+this.id+" tbody td:nth-child(1) input[type=checkbox]:checked");return _checkboxes}}function classCompose(a,c){this.template=TEMPLATES.layoutCompose;this.object=a;this.editable=Boolean(this.object.pk);this.perms=c.perms;this.name=c.name;this.meta=c.meta;this.compose=this.meta.related_name;this.model=this.meta.related_model;this.is_m2m=this.meta.is_many_to_many;this.id=validatorID([this.object.id,this.name,this.compose]);this.label=c.label;this.title=this.object.label+": "+this.label;this.query=null;this.fix={};this.m2m_fix=[];this.m2m_fixaction=null;this.paginator=null;var b={};this.actions=b;var d=this;REGISTER[this.id]=this}function classObject(f){this.template=TEMPLATES.layoutObject;this.model=REGISTER[validatorID(f.model)];this.pk=f.pk;this.id=this.pk?validatorID(f.model+"."+this.pk):generatorID(NEWOBJECTKEY);this.__unicode__=this.pk?f.__unicode__:"Новый объект ("+this.model.label+")";this.label=this.__unicode__;this.title=this.model.label+": "+this.label;var a=f.properties;this.properties=a;var d=f.fields;this.fields=d;this.get_fields=function(){L={};$.each(this.model.meta.fields,function(g,h){L[h]=d[h]});return L};this.get_column_value=function(g){if(g in d){return d[g]}else{if(g in a){return a[g]}}return""};var c=[];this.composes=c;this.widgets=this.model.meta.widgets;this.actions=this.model.actions;this.fix={};this.fixaction=null;var b=this;if(this.model.composes){$.each(this.model.composes,function(g,h){c.push(new classCompose(b,h))})}REGISTER[this.id]=this}function handlerCommitInstance(b,c){if(DEBUG){console.log("function:handlerCommitInstance")}var g=[];var i=b.model;var f=function(j){$.extend(true,j.fields,j.fix);g.push({pk:j.pk,fields:j.fields,model:j.model.name,action:j.fixaction,fix:j.fix,})};if((b instanceof classModel)||(b instanceof classCompose)){i=b;$.each(b.fix,function(j,k){f(k)})}else{f(b)}var d={method:"commit",objects:g,};var a=function(k,j,l){handlerCollectionGet(i);if(c){c()}};var h=new jsonAPI(d,a,"handlerCommitInstance(instance) call jsonAPI()",true,300000);return h}function handlerCommitComposeM2M(d,b){if(DEBUG){console.log("function:handlerCommitComposeM2M")}var c={method:"m2m_commit",model:d.object.model.name,pk:d.object.pk,compose:d.compose,action:d.m2m_fixaction,objects:d.m2m_fix,};var a=function(h,g,i){handlerCollectionGet(d);if(b){b()}};var f=new jsonAPI(c,a,"handlerCommitComposeM2M(compose, done) call jsonAPI()");return f}function handlerLayoutRender(a,c){if(DEBUG){console.log("function:handlerLayoutRender")}var b=a.template({data:a});if(!c){$("#layout_"+a.id).html(b);if(a instanceof classObject){$("#layout_"+a.id+" button[data-loading=true]").one("click",eventLayoutLoad)}}return b}function handlerLayoutLoad(a){if(DEBUG){console.log("function:handlerLayoutLoad")}handlerLayoutRender(a);if((a instanceof classModel)||(a instanceof classCompose)){handlerCollectionGet(a)}}function eventLayoutLoad(c){if(DEBUG){console.log("function:eventLayoutLoad")}var b=$(this).data(),a=REGISTER[b.id];handlerLayoutLoad(a);$(this).removeAttr("data-loading");c.preventDefault()}function handlerSelectAllToggle(){var a=$(this).parents("table"),b=a.find("tbody td:nth-child(1) input[type=checkbox]"),c=this.checked;$.each(b,function(d,f){f.checked=c})}function eventRowClick(b){if(DEBUG){console.log("function:eventRowClick")}var a=$(this);a.addClass("info").siblings("tr").removeClass("info")}function handlerCollectionRender(a,c){if(DEBUG){console.log("function:handlerCollectionRender")}if(a instanceof classObject){return""}var b=TEMPLATES.collection({data:a});if(!c){$("#collection_"+a.id).html(b)}return b}function handlerCollectionGet(b){if(DEBUG){console.log("function:handlerCollectionGet")}var d=[];if(b.filters){$.each(b.filters,function(g,h){d.push({active:h.active,field:h.field,type:h.type,inverse:h.inverse,values:h.values,field_title:h.field_title,type_title:h.type_title,})})}var c={method:"get_collection",model:b.model,compose:b.compose||null,ordering:b.meta.ordering||null,fields:b.meta.search_fields||null,filters:d,};c[b.meta.search_key]=b.query||null;if(b.object){c.pk=b.object.pk||0}if(b.paginator){c.page=b.paginator.page||1;c.per_page=b.paginator.per_page||null}var a=function(i,g,j){b.paginator=i.data;var h=handlerCollectionRender(b);handlerSearchSpinner(b.id,false)};var f=new jsonAPI(c,a,"handlerCollectionGet() call jsonAPI()");return f}function handlerSearchSpinner(c,b){if(DEBUG){console.log("function:handlerSearchSpinner")}var a=$("[data-action=collection_search_refresh][data-id="+c+"] .fa");if(b){a.addClass("fa-spin")}else{a.removeClass("fa-spin")}}function eventCollectionSearch(f){if(DEBUG){console.log("function:eventCollectionSearch")}var b=this,d=$(b).data(),a=REGISTER[d.id];val=$(b).val()||null,init_delay=500,len=val?val.length:0;a.query=val;var c=function(){handlerSearchSpinner(a.id,true);return handlerCollectionGet(a)};if(len>10){init_delay=100}else{if(len>9){init_delay=150}else{if(len>8){init_delay=200}else{if(len>7){init_delay=250}else{if(len>6){init_delay=300}else{if(len>5){init_delay=500}else{if(len>4){init_delay=700}else{if(len>3){init_delay=900}else{if(len>2){init_delay=1100}else{if(len>1){init_delay=1300}else{if(len>0){init_delay=1500}}}}}}}}}}}delay(c,init_delay);f.preventDefault()}function eventCollectionSearchRefresh(d){if(DEBUG){console.log("function:eventCollectionSearchRefresh")}var b=$("input[data-action=collection_search][data-id="+$(this).data().id+"]"),c=$(b).data(),a=REGISTER[c.id];handlerSearchSpinner($(this).data().id,true);a.query=$(b).val()||null;handlerCollectionGet(a);$(this).blur();d.preventDefault()}function eventCollectionCount(c){if(DEBUG){console.log("function:eventCollectionCount")}var b=$(this).data(),a=REGISTER[b.id];if(a.paginator){a.paginator.page=1;a.paginator.per_page=$(this).val()||$(this).data()["count"]||a.meta.list_per_page;$("[data-placeholder=collection_count][data-id="+a.id+"]").text(a.paginator.per_page)}handlerCollectionGet(a);c.preventDefault()}function eventCollectionPage(c){if(DEBUG){console.log("function:eventCollectionPage")}var b=$(this).data(),a=REGISTER[b.id];if(a.paginator){a.paginator.page=$(this).val()||$(this).data()["page"]||1}handlerCollectionGet(a);c.preventDefault()}function eventCollectionSorted(f){if(DEBUG){console.log("function:eventCollectionSorted")}var d=$(this).data(),b=REGISTER[d.id],a=b.meta.ordering||[],c=$.inArray(d.column,a);if(c>-1){a[c]="-"+d.column}else{c=$.inArray("-"+d.column,a);if(c>-1){a=a.slice(0,c).concat(a.slice(c+1))}}if(c==-1){a.push(d.column)}b.meta.ordering=a;handlerCollectionGet(b);f.preventDefault()}function handlerObjectAdd(b){if(DEBUG){console.log("function:handlerObjectAdd")}var c={method:"get_object",model:b.name,pk:null,filler:{},};if(b instanceof classCompose){c.filler[b.meta.related_field]=b.object.pk}var a=function(h,f,i){var g=new classObject(h.data);g.fixaction="add";g.model.fix[g.id]=g;handlerTabOpen(g)};var d=new jsonAPI(c,a,"handlerObjectAdd(model) call jsonAPI()");return d}function handlerTempUploadFile(a,d){if(DEBUG){console.log("function:handlerTempUploadFile")}var c=new FormData(),b=d.files[0],f=new XMLHttpRequest();if(!b){a.fix[d.name]=0;return true}else{c.append("file",b);f.open("POST","upload/"+a.model.name+"/",true);f.onload=function(h){var g=JSON.parse(this.response);a.fix[d.name]=g.data;$(d).siblings("button[name]").text(b.name).attr("title",b.name)};f.send(c);return true}}function handlerObjectChange(b,d){if(DEBUG){console.log("function:handlerObjectChange")}var a=d.attr("name"),c=d.attr("type"),f=d.val();if(c){c=c.toLowerCase()}if(c in {file:0,image:0}){$("#filelabel_"+b.id+"_"+a).removeClass("hide").text(f);handlerTempUploadFile(b,d[0])}else{if(c==="datetime-local"){f=$.dateParser(f,true)||f||null}else{if($.type(b.fields[a])==="array"){f=[f,d.text()]}else{if($.type(b.fields[a])==="boolean"){f=d.is(":checked")}}}}b.fix[a]=f;b.fixaction=b.fixaction||"change";b.model.fix[b.id]=b}function handlerObjectCopy(c,f){if(DEBUG){console.log("function:handlerObjectCopy")}if(c.id){var b=REGISTER[c.id],c={};c.model=b.model.name;c.pk=b.pk}var a={method:"get_object",model:c.model,pk:c.pk,copy:true,clone:f,};cb=function(i,g,j){var h=new classObject(i.data);h.fixaction="add";h.model.fix[h.id]=h;handlerTabOpen(h)};var d=new jsonAPI(a,cb,"handlerObjectCopy(data, clone) call jsonAPI()")}function handlerObjectDelete(d,b){if(DEBUG){console.log("function:handlerObjectDelete")}var c={method:"commit",objects:[{pk:d.pk,fields:{},model:d.model,action:"delete"}],};var a=function(h,g,i){handlerCollectionGet(REGISTER[validatorID(d.model)]);if(b){b()}};var f=new jsonAPI(c,a,"handlerObjectDelete(data, done) call jsonAPI()",true,180000)}function handlerObjectRowMuted(a){if(DEBUG){console.log("function:handlerObjectRowMuted")}$('tr[data-model="'+a.model.name+'"][data-pk="'+a.pk+'"]').addClass("muted")}function handlerObjectRowUnmuted(a){if(DEBUG){console.log("function:handlerObjectRowUnmuted")}$('tr[data-model="'+a.model.name+'"][data-pk="'+a.pk+'"]').removeClass("muted")}function eventObjectOpen(){if(DEBUG){console.log("function:eventObjectOpen")}var f=$(this),d=f.data();if(!d.model){return false}var c=REGISTER[d.id];if(c){handlerTabOpen(c);return null}var b={method:"get_object",model:d.model,pk:d.pk||null,};var a=function(j,h,k){var i=new classObject(j.data);f.data("id",i.id);handlerTabOpen(i)};var g=new jsonAPI(b,a,"eventObjectOpen() call jsonAPI()");return g}function eventObjectAdd(f){if(DEBUG){console.log("function:eventObjectAdd")}var d=$(this),c=d.data(),a=REGISTER[c.id],b=a.is_m2m?a:null;if((b)&&(f)&&(f.data)&&(f.data.m2m)){handlerM2MSelect(b);return true}handlerObjectAdd(a);f.preventDefault()}function eventObjectCopy(a){if(DEBUG){console.log("function:eventObjectCopy")}handlerObjectCopy($(this).data());a.preventDefault()}function eventObjectClone(){if(DEBUG){console.log("function:eventObjectClone")}handlerObjectCopy($(this).data(),true);e.preventDefault()}function eventObjectDelete(g){if(DEBUG){console.log("function:eventObjectDelete")}var a=undefined,f=$(this),c=f.data();if((g)&&(g.data)&&(g.data.m2m)){var d=REGISTER[c.id];d.m2m_fix=[c.pk];d.m2m_fixaction="delete";handlerCommitComposeM2M(d);return true}var b=REGISTER[c.id];if(b instanceof classObject){c.model=b.model.name;c.pk=b.pk;a=function(){handlerTabClose(b)}}var h="<b>Вы действительно желаете удалить этот объект?</b><br><i>Удаление невозможно обратить, если этот объект не рассчитан на перемещение в корзину.</i>";handlerModalShowSubmit(h,handlerObjectDelete,c,a);g.preventDefault()}function eventObjectChange(d){if(DEBUG){console.log("function:eventObjectChange")}var c=$(this),b=c.data(),a=REGISTER[b.id];handlerObjectChange(a,c);d.preventDefault()}function eventObjectReset(d){if(DEBUG){console.log("function:eventObjectReset")}var c=$(this),b=c.data(),a=REGISTER[b.id];a.fix={};handlerLayoutRender(a);d.preventDefault()}function eventObjectSave(d){if(DEBUG){console.log("function:eventObjectSave")}var c=$(this),b=c.data(),a=REGISTER[b.id];handlerCommitInstance(a,function(){handlerTabClose(a)});d.preventDefault()}function eventObjectSelect(c){if(DEBUG){console.log("function:eventObjectSelect")}var b=$(this),a=b.data();FIELD.val(a.pk).text(a.unicode).attr("title",a.unicode).change().siblings("button[disabled]").removeAttr("disabled");$("#modal").modal("hide");c.preventDefault()}function handlerM2MSelect(d){if(DEBUG){console.log("function:handlerM2MSelect")}var b=REGISTER[validatorID(d.name)],a=new classSelector(b,true),i="Выберите требуемые объекты",c=handlerLayoutRender(a,true),h=null,g={},f=[{model:b,action:"object_add",label:"Новый",css:"btn-warning"},{model:null,action:"modal_close",label:"Закрыть",css:"btn-default"},{model:d,action:"selector_append",label:"Добавить",css:"btn-info"},{model:d,action:"selector_submit",label:"Выбрать",css:"btn-primary"},];g={buttons:f,selector:a};h=TEMPLATES.modalFooter({mfoot:g,});handlerModalShow(i,c,h,function(){handlerCollectionGet(a)})}function handlerFieldSelect(f){if(DEBUG){console.log("function:handlerFieldSelect")}FIELD=f;var g=f.data(),c=REGISTER[g.id],b=REGISTER[validatorID(g.model)],a=new classSelector(b),i="Выберите требуемый объект",d=handlerLayoutRender(a,true),h=null;handlerModalShow(i,d,h,function(){handlerCollectionGet(a)})}function handlerSelectorSubmit(d,a){if(DEBUG){console.log("function:handlerSelectorSubmit")}var b=[],c=a.get_checked_items();$.each(c,function(f,g){b.push($(g).data().pk)});d.m2m_fix=b;d.m2m_fixaction="add";handlerCommitComposeM2M(d)}function eventFieldClear(c){if(DEBUG){console.log("function:eventFieldClear")}var b=$(this);b.attr("disabled","disabled");if((c)&&(c.data)&&(c.data.file)){var a=b.siblings("input[name]");a.val(null).change()}b.siblings("button[name]").val(null).html("&nbsp;").attr("title","").change();c.preventDefault()}function eventFieldSelect(c){if(DEBUG){console.log("function:eventFieldSelect")}var b=$(this);if((c)&&(c.data)&&(c.data.file)){b.siblings("input[name]").click()}else{var a=b.siblings("button[name]");handlerFieldSelect(a)}c.preventDefault()}function eventSelectorSubmit(f){if(DEBUG){console.log("function:eventSelectorSubmit")}var d=$(this),b=d.data(),c=REGISTER[b.id],a=REGISTER[validatorID([c.name,"selector"])];handlerSelectorSubmit(c,a);if(f.data.close){handlerModalHide()}f.preventDefault()}function handlerModalShowSubmit(j,g,i,h,f,d){if(DEBUG){console.log("function:handlerModalShowSubmit")}var b="Подтверждение",a=j,c=TEMPLATES.modalFooter({mfoot:{}});ACTION_WAIT=function(){g(i,h,f,d)};handlerModalShow(b,a,c)}function handlerModalShow(h,d,g,a){if(DEBUG){console.log("function:handlerModalShow")}var b=$("#modal"),f={};f.mhead=h;f.mbody=d;f.mfoot=g;var c=TEMPLATES.modal({modal:f});b.html(c).modal("show");if(a){a()}}function handlerModalHide(a){if(DEBUG){console.log("function:handlerModalHide")}$("#modal").modal("hide");if(a){a()}}function handlerMenuAppLoad(f){if(DEBUG){console.log("function:handlerMenuAppLoad")}var c=f?false:true,b={method:"get_apps"},a=function(i,g,k){var j=[];$.each(i.data,function(l,m){j.push(new classApp(m))});var h=TEMPLATES.menuApp({data:j});$("#menu-app ul[role=menu]").html(h);$("#menu-app").show();if(f){f()}};var d=new jsonAPI(b,a,"handlerMenuAppLoad() call jsonAPI()",c);return d}function handlerTabOpen(c){if(DEBUG){console.log("function:handlerTabOpen")}handlerObjectRowMuted(c);var b=$("#main-tab #tab_"+c.id);if(b.length>0){b.find("a").tab("show")}else{var a=TEMPLATES.layoutDefault({data:c});$("#main-tab-content").append(a);a=TEMPLATES.tab({data:c});$("#main-tab").append(a);delay(function(){$("#main-tab a:last").tab("show").click()},1);if((c.id.indexOf(NEWOBJECTKEY)==-1)&&($.inArray(c.id,SETTINGS.local.tabs)<0)&&($("#menu-app li[class!=disabled] a[data-id="+c.id+"]").size()>0)){SETTINGS.local.tabs.push(c.id);SETTINGS.save_local()}$("#tab_"+c.id+" a").one("click",eventLayoutLoad)}return true}function handlerTabClose(c){if(DEBUG){console.log("function:handlerTabClose")}var d=c?c.id:null;$("#tab_"+d).remove();$("#layout_"+d).remove();var a=REGISTER[d];if(a){handlerObjectRowUnmuted(a);if(a instanceof classObject){$.each(a.composes,function(f,g){delete REGISTER[g.id]});delete REGISTER[d]}}var b=$.inArray(d,SETTINGS.local.tabs);if(b>-1){delete SETTINGS.local.tabs[b];SETTINGS.cleanTabs().save_local()}$("#main-tab a:last").click()}function handlerTabRestore(){if(DEBUG){console.log("function:handlerTabRestore")}$.each(SETTINGS.local.tabs,function(a,b){$("#menu-app li[class!=disabled] a[data-id="+b+"]").click()})}function eventTabOpen(b){if(DEBUG){console.log("function:eventTabOpen")}var a=$(this).data();a=REGISTER[a.id]||a;handlerTabOpen(a);b.preventDefault()}function eventTabClose(b){if(DEBUG){console.log("function:eventTabClose")}var a=$(this).data();a=REGISTER[a.id]||a;handlerTabClose(a);b.preventDefault()}function handlerFiltersFromSettings(){if(DEBUG){console.log("function:handlerFiltersFromSettings")}if(!SETTINGS.local.filters){return false}$.each(SETTINGS.local.filters,function(b,c){var a=REGISTER[b];if(a){a.filters=c}});return true}function handlerFiltersRender(a){if(DEBUG){console.log("function:handlerFiltersRender")}if(a instanceof classObject){return false}var b=TEMPLATES.filters({data:a,is_new:false});$("#collection_filters_"+a.id).html(b);return b}function eventFilters(d){if(DEBUG){console.log("function:eventFilters")}var c=$(this).data(),a=REGISTER[c.id];if($("#list-filters_"+c.id).size()>0&&a.filters){$("#collection_filters_"+c.id).html("");var b=[];$.each(a.filters,function(f,g){if(g.field&&g.type&&g.values){b.push(g)}});a.filters=b}else{handlerFiltersRender(a)}$(this).blur();d.preventDefault()}function handlerFilterAppend(b){if(DEBUG){console.log("function:handlerFilterAppend")}if(b instanceof classObject){return false}var a=b.meta.filters[0]?b.meta.filters[0].field:null;if(!a){handlerShowAlert("Ошибка","Не установлены поля для фильтров.");return false}var d={type:null,inverse:false,active:false,field:null,values:null,field_title:null,type_title:null,};if(!b.filters){b.filters=[]}b.filters.push(d);var c=TEMPLATES.filter({data:b,item:d,index:b.filters.length-1,is_new:true});$("#list-filters_"+b.id).append(c);return c}function eventFilterAppend(b){if(DEBUG){console.log("function:eventFilterAppend")}var a=REGISTER[$(this).data().id];handlerFilterAppend(a);b.preventDefault()}function eventFilterRemove(d){if(DEBUG){console.log("function:eventFilterRemove")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index;a.filters.splice(b,b+1);$("#list-filters_"+a.id+" [data-filter_index="+b+"]").remove();handlerCollectionGet(a);if(!SETTINGS.local.filters){SETTINGS.local.filters={}}SETTINGS.local.filters[a.id]=a.filters;SETTINGS.save(null,"local");d.preventDefault()}function eventFilterChangeField(d){if(DEBUG){console.log("function:eventFilterChangeField")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index,f=$(this).val();text=$(this).find("[value="+f+"]").text();a.filters[b].field=f;a.filters[b].field_title=text;handlerFilterChangeActive(a,b,false);$("#list-filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]").html("");if(!f){$("#list-filters_"+a.id+" [data-action=filter_change_active][data-filter_index="+b+"]").attr("disabled","disabled");$("#list-filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").attr("disabled","disabled");$("#list-filters_"+a.id+" [data-action=filter_change_inverse][data-filter_index="+b+"]").attr("disabled","disabled");$("#list-filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]").html("")}else{$("#list-filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").removeAttr("disabled")}d.preventDefault()}function eventFilterChangeType(g){if(DEBUG){console.log("function:eventFilterChangeType")}var f=$(this).data(),a=REGISTER[f.id],b=f.filter_index,h=$(this).val();text=$(this).find("[value="+h+"]").text();a.filters[b].type=h;a.filters[b].type_title=text;handlerFilterChangeActive(a,b,false);if(!h){$("#collection_filters_"+a.id+" [data-action=filter_change_active][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-action=filter_change_inverse][data-filter_index="+b+"]").attr("disabled","disabled");$("#collection_filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]").html("");handlerCollectionGet(a);return true}$("#list-filters_"+a.id+" [data-action=filter_change_active][data-filter_index="+b+"]").removeAttr("disabled");$("#list-filters_"+a.id+" [data-action=filter_change_inverse][data-filter_index="+b+"]").removeAttr("disabled");var c=TEMPLATES.filter_values({data:a,index:b}),d=$("#list-filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]");if(a.filters[b].type!="blank"){d.html(c);if(a.filters[b].type=="range"){d.append(c)}}g.preventDefault()}function handlerFilterChangeActive(a,b,c){if(DEBUG){console.log("function:handlerFilterChangeActive")}a.filters[b].active=c;return true}function eventFilterChangeActive(f){if(DEBUG){console.log("function:eventFilterChangeActive")}var d=$(this).data(),a=REGISTER[d.id],b=d.filter_index,c=!$(this).hasClass("active");handlerFilterChangeValues(a,b);handlerFilterChangeActive(a,b,c);if(c){$("#list-filters_"+a.id+" [data-action=filter_change_field][data-filter_index="+b+"]").attr("disabled","disabled");$("#list-filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").attr("disabled","disabled")}else{$("#list-filters_"+a.id+" [data-action=filter_change_field][data-filter_index="+b+"]").removeAttr("disabled");$("#list-filters_"+a.id+" [data-action=filter_change_type][data-filter_index="+b+"]").removeAttr("disabled")}handlerCollectionGet(a);f.preventDefault()}function handlerFilterChangeInverse(a,c,b){if(DEBUG){console.log("function:handlerFilterChangeInverse")}a.filters[c].inverse=b;return true}function eventFilterChangeInverse(f){if(DEBUG){console.log("function:eventFilterChangeInverse")}var d=$(this).data(),a=REGISTER[d.id],b=d.filter_index,c=!$(this).hasClass("active");handlerFilterChangeInverse(a,b,c);if(a.filters[b].active){handlerCollectionGet(a)}f.preventDefault()}function handlerFilterChangeValues(a,b){if(DEBUG){console.log("function:handlerFilterChangeValues")}var d=$("#list-filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]"),c=d.find("[data-action=filter_change_values]");a.filters[b].values=[];a.filters[b].values_html=d.html();if(!SETTINGS.local.filters){SETTINGS.local.filters={}}SETTINGS.local.filters[a.id]=a.filters;SETTINGS.save(null,"local");$.each(c,function(f,g){a.filters[b].values.push($(g).val())});return true}function eventFilterChangeValues(d){if(DEBUG){console.log("function:eventFilterChangeValues")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index,f=$(this).val();if(f){$(this).attr("value",f)}handlerFilterChangeActive(a,b,false);handlerFilterChangeValues(a,b);if(a.filters[b].active){handlerCollectionGet(a)}d.preventDefault()}function handlerFilterAppendValue(a,b){if(DEBUG){console.log("function:handlerFilterAppendValue")}var c=TEMPLATES.filter_values({data:a,index:b}),d=$("#list-filters_"+a.id+" [data-place=filter_values][data-filter_index="+b+"]");d.append(c);return true}function eventFilterAppendValue(d){if(DEBUG){console.log("function:eventFilterAppendValue")}var c=$(this).data(),a=REGISTER[c.id],b=c.filter_index;handlerFilterAppendValue(a,b);$(this).remove();d.preventDefault()}function eventCollectionPrint(g){if(DEBUG){console.log("function:eventCollectionPrint")}var f=$(this).data(),b=REGISTER[f.id],d=true,c={method:"get_collection_report_url",report:f.report,model:b.model,query:b.query,order_by:b.order_by,fields:b.fields,filters:b.filters,},a=function(k,i,l){var j=k.data;window.open(j,"_blank")};var h=new jsonAPI(c,a,"eventCollectionPrint() call jsonAPI()",d);g.preventDefault()}function eventObjectPrint(g){if(DEBUG){console.log("function:eventObjectPrint")}var f=$(this).data(),c=REGISTER[f.id],d=true,b={method:"get_object_report_url",model:f.model,pk:f.pk,report:f.report,},a=function(i,h,j){window.open(i.data,"_blank")};jqxhr=new jsonAPI(b,a,"eventObjectPrint() call jsonAPI()",d);return true}function eventWaitCancel(a){if(DEBUG){console.log("function:eventWaitCancel")}ACTION_WAIT=null;a.preventDefault()}function eventWaitSubmit(a){if(DEBUG){console.log("function:eventWaitSubmit")}ACTION_WAIT();ACTION_WAIT=null;a.preventDefault()}function handlerTemplates(){if(DEBUG){console.log("function:handlerTemplates")}TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.menuApp=_.template($("#underscore-menu-app").html());TEMPLATES.collection=_.template($("#underscore-collection").html());TEMPLATES.layoutModel=_.template($("#underscore-layout-model").html());TEMPLATES.layoutSelector=_.template($("#underscore-layout-selector").html());TEMPLATES.layoutCompose=_.template($("#underscore-layout-compose").html());TEMPLATES.layoutObject=_.template($("#underscore-layout-object").html());TEMPLATES.layoutDefault=_.template($("#underscore-layout-default").html());TEMPLATES.tab=_.template($("#underscore-tab").html());TEMPLATES.modal=_.template($("#underscore-modal").html());TEMPLATES.modalFooter=_.template($("#underscore-modal-footer").html());TEMPLATES.filter=_.template($("#underscore-filter").html());TEMPLATES.filters=_.template($("#underscore-filters").html());TEMPLATES.filter_values=_.template($("#underscore-filter-values").html());return true}function handlerBindinds(){if(DEBUG){console.log("function:handlerBindinds")}$("body").on("click","tr[data-pk]",eventRowClick);$("#menu-app li[class!=disabled]").on("click","a",eventTabOpen);$("#main-tab").on("click","button.close[data-id]",eventTabClose);$("body").on("click",".btn-group button[data-toggle=tab]",function(b){var a=$(this).hasClass("active");if(!a){$(this).blur().siblings("button").removeClass("active")}else{b.preventDefault()}});handlerTabRestore();$("body").on("keyup","[data-action=collection_search]",eventCollectionSearch);$("body").on("change","[data-action=collection_search]",eventCollectionSearch);$("body").on("click","[data-action=collection_search_refresh]",eventCollectionSearchRefresh);$("body").on("click","[data-action=collection_count]",eventCollectionCount);$("body").on("change","[data-action=collection_page]",eventCollectionPage);$("body").on("click","[data-action=collection_page]",eventCollectionPage);$("body").on("click","th.sorted",eventCollectionSorted);$("body").on("click","[data-action=object_open]",eventObjectOpen);$("body").on("click","[data-action=object_copy]",eventObjectCopy);$("body").on("click","[data-action=object_clone]",eventObjectClone);$("body").on("click","[data-action=object_add]",eventObjectAdd);$("body").on("click","[data-action=object_add_m2m]",{m2m:true},eventObjectAdd);$("body").on("click","[data-action=object_delete]",eventObjectDelete);$("body").on("click","[data-action=object_delete_m2m]",{m2m:true},eventObjectDelete);$("body").on("keyup","[data-action=object_change]",eventObjectChange);$("body").on("change","[data-action=object_change]",eventObjectChange);$("body").on("click","[data-action=object_reset]",eventObjectReset);$("body").on("click","[data-action=object_save]",eventObjectSave);$("body").on("click","[data-action=object_select]",eventObjectSelect);$("#modal").on("click","[data-action=selector_append]",{close:false},eventSelectorSubmit);$("#modal").on("click","[data-action=selector_submit]",{close:true},eventSelectorSubmit);$("#modal").on("click","[data-action=wait_cancel]",eventWaitCancel);$("#modal").on("click","[data-action=wait_submit]",eventWaitSubmit);$("body").on("click","[data-action=field_clear]",eventFieldClear);$("body").on("click","[data-action=file_field_clear]",{file:true},eventFieldClear);$("body").on("click","[data-action=field_select]",eventFieldSelect);$("body").on("click","[data-action=file_field_select]",{file:true},eventFieldSelect);$("body").on("click","[data-toggle=checkboxes]",handlerSelectAllToggle);$("body").on("click","[data-action=collection_filters]",eventFilters);$("body").on("click","[data-action=filter_append]",eventFilterAppend);$("body").on("click","[data-action=filter_remove]",eventFilterRemove);$("body").on("click","[data-action=filter_change_field]",eventFilterChangeField);$("body").on("click","[data-action=filter_change_type]",eventFilterChangeType);$("body").on("click","[data-action=filter_change_inverse]",eventFilterChangeInverse);$("body").on("click","[data-action=filter_change_active]",eventFilterChangeActive);$("body").on("click","[data-action=filter_change_values]",eventFilterChangeValues);$("body").on("change","[data-action=filter_change_values]",eventFilterChangeValues);$("body").on("click","[data-action=filter_append_value]",eventFilterAppendValue);$("body").on("click","[data-action=collection_print]",eventCollectionPrint);$("body").on("click","[data-action=object_print]",eventObjectPrint);return true}function datetimeLocale(c){var b=$.dateParser(c);if(b){var a=function(d){if(d<10){return"0"+d}return d};year=b.getFullYear(),month=a(b.getMonth()+1),day=a(b.getDate()),hours=a(b.getHours()),minutes=a(b.getMinutes()),seconds=a(b.getSeconds());return year+"-"+month+"-"+day+"T"+hours+":"+minutes+":"+seconds}return c}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}handlerTemplates();a("#menu-app").hide();a("#menu-func").hide();handlerMenuAppLoad(function(){window.SETTINGS=new classSettings();a("alert").alert();a(".dropdown-toggle").dropdown();window.SETTINGS.init(function(){a("#search").focus();handlerBindinds();handlerFiltersFromSettings();moment.locale(a("html").attr("lang"))})})});