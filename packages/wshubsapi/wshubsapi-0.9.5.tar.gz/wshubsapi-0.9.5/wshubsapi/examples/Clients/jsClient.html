<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
    <title>tornado WebSocket example</title>
    <!--File auto-generated by the server.
    Path needs to match with Hub.constructJSFile path parameter-->
    <script type="text/javascript" src="_static/hubsApi.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.js"></script>
</head>
<body>
<div class="container">
    <h1>tornado WebSocket example with WSHubsAPI</h1>
    <hr>
    WebSocket status : <span id="status">Waiting connection</span><br>
    Name: <input type="text" id="name" value="Kevin"/><br>
    <input type="text" id="message"/>
    <input type="button" id="sendmessage" value="Send"/>
    <input type="hidden" id="displayname"/>
    <ul id="discussion">
    </ul>
</div>
<script>
    var hubsApi = new HubsAPI();
    function sendToAll() {
        var name = $('#name').val(),
            message = $('#message').val();
        $('#discussion').append('<li><strong> Me'
            + '</strong>: ' + message + '</li>');


        hubsApi.ChatHub.server.sendToAll(name, message)
            .then(function (numOfMessagesSent) {
                console.log("message sent to " + numOfMessagesSent + " client(s)");
            }, function (err) {
                console.log("message not sent " + err);
            }).finally(function () {
                console.log("I am in finnally");
            });
        $('#message').val('').focus();
    }

    hubsApi.connect('ws://127.0.0.1:8888/').then(function () {
        $('#status').text("Connected")

        //sending message
        $('#sendmessage').click(sendToAll);
        $('#message').keypress(function (e) {
            if (e.which == 13)
                sendToAll()
        });
    }, function (error) {
        console.error(error);
    });

    //function to be called from server
    hubsApi.ChatHub.client.printMessage = function (from, message) {
        $('#discussion').append('<li><strong>' + from
            + '</strong>: ' + message + '</li>');
        return "received"
    }

    hubsApi.wsClient.onerror = function (ev) {
        console.error(ev.reason);
    };
</script>
</body>
</html>
